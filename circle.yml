machine:
  pre:
  node:
      version: 0.10.45
  services:
    - redis
    - docker
checkout:
  pre:
    - mkdir -p $HOME/docker
    - cd $HOME/docker
  override:
    - git clone git@github.com:PSESD/CBO-Portal-API.git api
    - cd api
    - git pull origin develop

dependencies:
  override:
    - docker info
    - docker build -t psesd/ssl-api:develop .

test:
  override:
    - docker run -d --name api --link redis:redis -p 104.192.103.12:443:443 -e "NODE_ENV=development" -e "NODE_CONFIG_DIR=/config" -v /config:/config psesd/ssl-api:develop; sleep 10
    - curl --retry 10 --retry-delay 5 -v https://api.cbo.upward.st

deployment:
  hub:
    branch: develop
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push psesd/ssl-api:develop